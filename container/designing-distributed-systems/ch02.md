本:『分散システムデザインパターン』

## I部 シングルノードパターン

### Kubernetes の Pod 

* 1つ以上のアプリケーションコンテナ(Dockerやrktなど)のグループとそれらのコンテナの共有リソースを表すKubernetesの抽象概念
* Podに含まれるもの:
  * 共有ストレージ(ボリューム)
  * ネットワーキング(クラスタに固有のIPアドレス)
  * コンテナのイメージバージョンや使用するポートなどの、各コンテナをどう動かすかに関する情報
* Pod内のコンテナはIPアドレスとポートスペースを共有し、常に同じ場所に配置され、同じスケジュールに入れられ、同じNode上の共有コンテキストで実行される

参考:
https://kubernetes.io/ja/docs/tutorials/kubernetes-basics/explore/explore-intro/

## 2章 サイドカー

以下のコンテナ2台で構成される:

1. アプリケーション本体
2. アプリケーションに付随する機能（サイドカー）

### 例

#### 2.1. HTTP で提供されたレガシーサービスを HTTPS 化する

* このパターンが必要になる状況
  * HTTP でサービスを提供するレガシーなWebアプリケーションを HTTPS 化したい
* 具体的な構成
  * レガシーアプリケーション
  * SSLプロキシ（サイドカー）
* SSLプロキシからWebアプリケーションにリクエストをフォワードする

#### 2.2. 動的なコンフィグ管理

* このパターンが必要になる状況
  * アプリケーションの設定ファイルを、コンテナ外のAPIから動的に変更したい
* 具体的な構成
  * レガシーアプリケーション
  * 設定マネージャ（サイドカー）
  * 共有ファイルシステム（設定ファイルを置く）
* 設定マネージャからレガシーアプリケーションに SIGKILL を送ったりする場合もある（ミドルウェアの再起動のためなど）

#### 2.3. モジュール化されたアプリケーションコンテナ

* このパターンが必要になる状況
  * top コマンドのような管理用アプリケーションや、デバッグ用の機能を、元のアプリケーションのコードを変更することなく追加したい
* 具体的な構成
  * レガシーアプリケーション
  * topz (サイドカー)

### 2.4. 実装例: サイドカーを使ったシンプルなPaaS

* 要件
  * アプリケーションのソースコードをソース管理リポジトリに Push すると、変更内容が自動的にアプリケーションに反映されるしくみを作る（自前のPaaSのようなもの）
* 実装方法
  * リモートのソース管理リポジトリの状態を監視し、現状と差分があればその内容をローカルに同期する
  * 新しいファイルがアップロードされると自動的にサーバをリロードする
    * nodemon(https://hodemon.io)
* 構成
  * Node.js のアプリケーションを動かすコンテナ
  * Git 同期コンテナ
  * 共有ファイル（Gitのソースコード）

例: ローカルに最新のリモートリポジトリの内容を同期するスクリプト:

```bash
#!/bin/bash

while true; do
  git pull
  sleep 10
done
```

## 2.5. モジュール化と再利用性を考えたサイドカーの設計

サイドカーのメリットは、異なるアプリケーションで同じコンテナを再利用できること
=> アプリケーションのモジュール化と同様、再利用性の高い設計が求められる

気をつけること:

1. コンテナのパラメータ化
2. コンテナのAPI仕様の設計
3. コンテナのオペレーションのドキュメント化

### 1. パラメータ化

* 個別の環境ごとに異なる設定をパラメータ化して外部から注入する
    * 環境変数 or コマンドライン引数を使う

```console
$ docker run -e=PORT=8080 -d <sidecar-image>
```

### 2. API仕様の設計

* そのコンテナが周りとやりとりする方法のすべての API を定義する必要がある
  * コンテナ起動時のパラメータ
  * HTTPリクエスト
  * CLI など
* APIを可能なかぎり不変に保ち、破壊的変更が入らないように注意する

### 3. コンテナのドキュメント化

すぐに使ってもらえるようにするために仕様をドキュメント化する
* Dockerfile にコメントを書く
* 共通言語を採用する
  * Label Schema (http://label-schema.org/rc1/)
